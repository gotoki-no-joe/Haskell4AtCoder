# フェニック木2

こんなガチガチの説明誰も読みたくないよね。

固定長の数列があり、その先頭からの部分和と要素の更新を繰り返し行うときに、両方を$$O(\log n)$$で行えるデータ構造とアルゴリズム。手続き的な実装では二分木をmutableな配列に敷き詰めるが、ここでは原理に忠実に木で実装する。

2のべき乗であるような$$W$$に対して、1つの木は$$W$$個以上$$2W$$個未満の連続する要素に関する情報を保持している。  
その根は先頭からの$$W$$要素の和をラベルとして持ち、左の部分木は先頭からの$$W-1$$要素に関する情報を保持し、右の部分木は（もしあれば）残りの要素に関する情報を保持する。  
なお、要素1つに関する木は根だけからなり子を持たない。

長さ1の数列$$a_1$$に対する木は単一の節からなり、その節はラベル$$a_1$$が付き子を持たない。

2のべき乗であるような$$W$$に関して、長さ$$W$$の数列$$a_1,\dots,a_W$$に対する木の根は、ラベルとして総和$$s_L = \sum_{i=1}^W a_i$$が付き、$$a_1,\dots,a_{W-1}$$に関する左の子$$t_L$$を持ち、右の子を持たない。  
同じく長さ$$W$$の数列$$a_{W+1},\dots,a_{2W}$$に対する木は、ラベルとして総和$$s_R = \sum_{i=W+1}^{2W} a_i$$が付き、$$a_{W+1},\dots,a_{2W-1}$$に関する左の子$$t_R$$を持ち、右の子を持たない。

これらから、長さ$$2W$$の数列$$a_1,\dots,a_{2W}$$に対する木を、次のように構築できる。  
まず、根のラベルは$$s = \sum_{i=1}^{2W} a_i = S_L + S_R$$で、根は右の子を持たない。  
ここで先頭からの$$2W-1$$要素に関する情報を持つ左の子は、次のように構築できる。  
根のラベルは$$\sum_{i=1}^W a_i = s_L$$である。左の部分木は$$t_L$$である。後半の$$W-1$$要素$$a_W,\dots,a_{2W-1}$$に関する部分木は$$t_R$$がそれである。

数列の末尾に適宜0を補うことで、要素数を2のべき乗に揃えることができる。すると木は完全二分木になる。このとき、木の高さから個々の頂点が関係する要素数は得られる（葉までの距離が$$d$$の頂点は$$2^d$$要素に関係する）ので、個々の頂点がそれを記録しておく必要はない。

